<!DOCTYPE HTML>
<html>
  <head>
    <title>Pacman</title>
    <meta charset="utf-8">
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #000;
      }
    </style>
    <!--<script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>		ONLINE-->
  	<script src="phaser.min.js"></script>										<!--OFFLINE-->
  </head>

  <body>
    <script type="text/javascript">

      var game = new Phaser.Game(752, 496, Phaser.AUTO);

      var ToggleZombies = 1;
    	var pltfrmCheck = false;
    	var hitme = 1;
    	var justGotHere = 0;
      var placedPlayer=0;

    	var ChoseDif = false;
    	var DifContinue = null;
    	var OK = false;
    	var timer;
    	var tcount = 4;
    	var scount = "";
    	var gametimeM = "-";
    	var gametimeS = "-";
    	var Rtile = "";
    	var SpeedCD = null;
    	var SunSerialKiller = 0;
    	Zdir = null;
    	Zranddir = null;

      var Pacman = function () {

        this.map = null;
        this.layer = null;
    		this.layer1 = this.layer;
        this.pacman = null;
    		this.z1 = null;
    		this.z2 = null;
    		this.z3 = null;
    		this.z4 = null;
    		this.z5 = null;
    		this.z6 = null;
    		this.RegZombieSpeed = 100;
    		this.FullZombieSpeed = 150;

    		this.score= 0;
    		this.lives= 1;
    		this.life1 = null;
    		this.life2 = null;
    		this.life3 = null;
    		this.dead = false;

        this.safetile = 1;
        this.gridsize = 16;

        this.speed = 150;
        this.threshold = 5;

        this.marker = new Phaser.Point();
        this.turnPoint = new Phaser.Point();

        this.directions = [ null, null, null, null, null ];
        this.opposites = [ Phaser.NONE, Phaser.RIGHT, Phaser.LEFT, Phaser.DOWN, Phaser.UP ];

        this.current = Phaser.NONE;
        this.turning = Phaser.NONE;
    		this.Zcurrent = Phaser.NONE;
        this.Zturning = Phaser.NONE;
    		this.Zdir = Phaser.NONE;
    		this.Zranddir = Phaser.NONE;

      };

      Pacman.prototype = {

        init: function () {
      		// Maintain aspect ratio
          this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;

      		// Keep original size
      		//this.scale.fullScreenScaleMode = Phaser.ScaleManager.NO_SCALE;

      		// Stretch to fill
      		//this.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;

          this.scale.pageAlignHorizontally = true;
          this.scale.pageAlignVertically = true;

          Phaser.Canvas.setImageRenderingCrisp(this.game.canvas);

    			//this.game.renderer.renderSession.roundPixels = true;
          this.physics.startSystem(Phaser.Physics.ARCADE);
        },

        preload: function () {

          //  We need this because the assets are on github pages
          //  Remove the next 2 lines if running locally
          //this.load.baseURL = 'https://psarrask.github.io/pacman/';			/////////////////////////
          //this.load.crossOrigin = 'anonymous';								/////////////////////////

    			this.load.image('pvzbutton', 'assets/pvzbutton.png');
          this.load.image('drop', 'assets/drop.png');
    			this.load.image('sun', 'assets/sun.png');
    			this.load.image('superspeed', 'assets/superspeed.png');
    			this.load.image('life', 'assets/life.png');
          this.load.image('tiles', 'assets/pacman-tiles.png');
    			this.load.image('InfoDim', 'assets/info.png');
          this.load.spritesheet('pacman', 'assets/pacman.png', 32, 53);
    			this.load.spritesheet('zombie', 'assets/zombie.png', 32, 53);
          this.load.tilemap('map', 'assets/pacman-map.json', null, Phaser.Tilemap.TILED_JSON);

    			///////SOUNDS///////
    			this.load.audio('getSUN', 'assets/EatSun.mp3');
    			this.load.audio('get20DROPS', 'assets/Eat20Drops.mp3');
    			this.load.audio('getALLDROPS', 'assets/GetAllDrops.mp3');
    			this.load.audio('MUSIC', 'assets/pvzm.mp3');
    			this.load.audio('PRAOU', 'assets/PraouPraou.mp3');
    			this.load.audio('Beeep', 'assets/beep.m4a');
    			this.load.audio('Hahaha', 'assets/Laugh.mp3');
    			this.load.audio('IncomingWave', 'assets/Wave.mp3');
        },


        create: function () {

    			this.cursors = this.input.keyboard.createCursorKeys();

    			//  SOUNDS
    			PVZM = game.add.audio('MUSIC');
    			EatSun = game.add.audio('getSUN');
    			Eat20Drops = game.add.audio('get20DROPS');
    			EatALLDrops = game.add.audio('getALLDROPS');
    			PraouPraou = game.add.audio ('PRAOU');
    			BEEP = game.add.audio('Beeep');
    			Laugh = game.add.audio('Hahaha');
    			Wave = game.add.audio('IncomingWave');

    			// MAP
          this.map = this.add.tilemap('map');
          this.map.addTilesetImage('pacman-tiles', 'tiles');

          this.layer = this.map.createLayer('Pacman');
    			this.layer2 = this.map.createLayer('Z');

    			// COLLECTIBLES
          this.drops = this.add.physicsGroup();
    			this.suns = this.add.physicsGroup();
    			this.superspeed = this.add.physicsGroup();
    			this.teleport1 = this.add.physicsGroup();
    			this.teleport2 = this.add.physicsGroup();
    			this.teleport3 = this.add.physicsGroup();
    			this.teleport4 = this.add.physicsGroup();

          this.map.createFromTiles(2, this.safetile, 'drop', this.layer, this.drops);
    			this.map.createFromTiles(3, this.safetile, 'sun', this.layer, this.suns);
    			this.map.createFromTiles(4, this.safetile, 'superspeed', this.layer2, this.superspeed);
    			this.superspeed.callAll('kill');
          this.map.createFromTiles(62, this.safetile, null, this.layer);
    			this.map.createFromTiles(63, this.safetile, null, this.layer);
    			this.map.createFromTiles(46, this.safetile, null, this.layer, this.teleport1);
    			this.map.createFromTiles(47, this.safetile, null, this.layer, this.teleport2);
          this.map.createFromTiles(170, this.safetile, null, this.layer);
    			this.map.createFromTiles(171, this.safetile, null, this.layer);
    			this.map.createFromTiles(154, this.safetile, null, this.layer, this.teleport3);
    			this.map.createFromTiles(155, this.safetile, null, this.layer, this.teleport4);

          //  The drops will need to be offset by 6px to put them back in the middle of the grid
          this.drops.setAll('x', 6, false, false, 1);
          this.drops.setAll('y', 5, false, false, 1);

          //  Pacman should collide with everything except the safe tile
          this.map.setCollisionByExclusion([1, 82, 83, 84, 85], true, this.layer);
    			this.map.setCollisionByExclusion([1, 82, 83, 84, 85], true, this.layer2);

    			//-----------------PACMAN-----------------\\
          //  Position Pacman at grid location 14x17 (the +8 accounts for his anchor)
          this.pacman = this.add.sprite((16 * 16) + 8, (15 * 16) + 8, 'pacman', 0);
          this.pacman.anchor.set(0.5);

    			this.physics.arcade.enable(this.pacman);
          this.pacman.body.setSize(16, 16, 0, 0);

    			//  MUNCH ANIMATIONS
          this.pacman.animations.add('munchRL', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], 40, true);
    			this.pacman.animations.add('munchUP', [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 40, true);
    			this.pacman.animations.add('munchDOWN', [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 40, true);

    			this.pacman.play('munchRL');
    			this.move(Phaser.NONE);
    			this.input.disabled = false;
    			this.pacman.visible = false;

          if (ToggleZombies){
      			//------------------ZOMBIE 1------------------\\
      			//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
            this.z1 = this.add.sprite((9 * 16) + 8, (13 * 16) + 8, 'zombie', 0);
            this.z1.anchor.set(0.5);
      			this.z1.speed = this.RegZombieSpeed;

      			this.physics.arcade.enable(this.z1);
            this.z1.body.setSize(16, 16, 0, 0);

      			this.z1.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      			this.z1.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      			this.z1.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      			this.z1.play('walkRL');
      			this.Zcurrent = Phaser.RIGHT;

      			//------------------ZOMBIE 2------------------\\
      			//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
            this.z2 = this.add.sprite((15 * 16) + 8, (24 * 16) + 8, 'zombie', 0);
            this.z2.anchor.set(0.5);
      			this.z2.speed = this.RegZombieSpeed;

      			this.physics.arcade.enable(this.z2);
            this.z2.body.setSize(16, 16, 0, 0);

      			this.z2.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      			this.z2.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      			this.z2.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      			this.z2.play('walkRL');
      			this.Zcurrent = Phaser.RIGHT;

      			//------------------ZOMBIE 3------------------\\
      			//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
            this.z3 = this.add.sprite((39 * 16) + 8, (8 * 16) + 8, 'zombie', 0);
            this.z3.anchor.set(0.5);
      			this.z3.speed = this.RegZombieSpeed;

      			this.physics.arcade.enable(this.z3);
            this.z3.body.setSize(16, 16, 0, 0);

      			this.z3.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      			this.z3.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      			this.z3.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      			this.z3.play('walkRL');
      			this.Zcurrent = Phaser.RIGHT;

      			//------------------ZOMBIE 4------------------\\
      			//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
            this.z4 = this.add.sprite((32 * 16) + 8, (20 * 16) + 8, 'zombie', 0);
            this.z4.anchor.set(0.5);
      			this.z4.speed = this.RegZombieSpeed;

      			this.physics.arcade.enable(this.z4);
            this.z4.body.setSize(16, 16, 0, 0);

      			this.z4.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      			this.z4.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      			this.z4.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      			this.z4.play('walkRL');
      			this.Zcurrent = Phaser.RIGHT;
          }
    			//########### SCREEN MESSAGES & INFO ###########\\
    			//  Lives
    			this.life1 = this.add.sprite(175, 472, 'life');
    			this.life2 = this.add.sprite(195, 472, 'life');
    			this.life3 = this.add.sprite(215, 472, 'life');

    			this.life2.visible = false;
    			this.life3.visible = false;

    			this.CurrentLives1 = game.add.text(120, 471.6, "Lives: " + this.lives, { fontSize: "19px", fill: "#133913"});
    			this.CurrentLives2 = game.add.text(119, 470, "Lives: " + this.lives, { fontSize: "19px", fill: "#2d862d"});

    			//  Score
    			this.CurrentScore1 = game.add.text(528, 471.6, "Score: " + this.score, { fontSize: "19px", fill: "#133913"});
    			this.CurrentScore2 = game.add.text(527, 470, "Score: " + this.score, { fontSize: "19px", fill: "#2d862d"});

    			//  SuperSpeed Count-Down
    			this.SpeedHurry1 = game.add.text(367.5, 11.5, Rtile, { fontSize: "40px", fill: "#000"});
    			this.SpeedHurry2 = game.add.text(365, 10, Rtile, { fontSize: "40px", fill: "#fff"});

    			//  KILL THEM ALL!
    			this.KILLtext = game.add.text(350, 130, "KILL", { fontSize: "25px", fill: "#fff"});
    			this.THEMtext = game.add.text(342, 150, "THEM", { fontSize: "25px", fill: "#fff"});
    			this.ALLtext = game.add.text(350, 170, "ALL!", { fontSize: "25px", fill: "#fff"});
    			this.KILLtext.visible = false;
    			this.THEMtext.visible = false;
    			this.ALLtext.visible = false;

    			// THE ZOMBIES ARE HUNGRY!
    			this.THEtext = game.add.text(358, 301, "THE", { fontSize: "17px", fill: "#fff"});
    			this.ZOMBIEStext = game.add.text(337, 319, "ZOMBIES", { fontSize: "17px", fill: "#fff"});
    			this.AREtext = game.add.text(358, 337, "ARE", { fontSize: "17px", fill: "#fff"});
    			this.HUNGRYtext = game.add.text(337, 355, "HUNGRY!", { fontSize: "17px", fill: "#fff"});
    			this.THEtext.visible = false;
    			this.ZOMBIEStext.visible = false;
    			this.AREtext.visible = false;
    			this.HUNGRYtext.visible = false;

    			//  Starting Count-Down and Time
    			timer = game.time.create(false);
    			timer.loop(1000, this.updateCounter, this);
    			timer.start();
    			this.StartCount = game.add.text(350, 231, scount, { fontSize: "30px", fill: "#fff"});
    			this.StartGameTime1 = game.add.text(329.5, 471.5, "Time: " + gametimeM + "':" + gametimeS + "''", { fontSize: "19px", fill: "#000"});
    			this.StartGameTime2 = game.add.text(327, 470, "Time: " + gametimeM + "':" + gametimeS + "''", { fontSize: "19px", fill: "#fff"});

    			//************************************************************ DIFFICULTY BUTTONS ************************************************************\\
    			this.cDifText2 = game.add.text(236.5, 235.5, 'Please choose your difficulty:', { fontSize: "20px", fill: "#000"});
    			this.cDifText = game.add.text(235, 234, 'Please choose your difficulty:', { fontSize: "20px", fill: "#fff"});

    			DifBut1 = this.add.sprite( 241.5, 263.5, 'pvzbutton');
    			DifText1 = game.add.text( 267, 270, 'EASY', { fontSize: '15px', fill: '#ffffff' });

    			DifText1.inputEnabled = true;
    			DifText1.events.onInputUp.add(function () {
    				if( this.OK == true ){
    					this.DifContinue = 1;
    				}
    			});

    			DifBut2 = this.add.sprite( 331.5, 263.5, 'pvzbutton');
    			DifText2 = game.add.text( 346, 270, 'MEDIUM', { fontSize: '15px', fill: '#ffffff' });

    			DifText2.inputEnabled = true;
    			DifText2.events.onInputUp.add(function () {
    				if( this.OK == true ){
    					this.DifContinue = 2;
    				}
    			});

    			DifBut3 = this.add.sprite( 421.5, 263.5, 'pvzbutton');
    			DifText3 = game.add.text( 445, 270, 'HARD', { fontSize: '15px', fill: '#ffffff' });

    			DifText3.inputEnabled = true;
    			DifText3.events.onInputUp.add(function () {
    				if( this.OK == true ){
    					this.DifContinue = 3;
    				}
    			});
    			//************************************************************ DIFFICULTY BUTTONS ************************************************************\\

    			//this.InfodimBack = this.add.sprite( 26, 23, 'InfoDim');

    			//************* PAUSE BUTTON *************\\
    			this.but = this.add.sprite( 331.5, 442.5, 'pvzbutton');
    			pause_label = game.add.text( 337, 445, 'PAUSE', { fontSize: '23px', fill: '#ffffff' });

    			pause_label.inputEnabled = true;
    			pause_label.events.onInputUp.add(function () {
    				// When the paus button is pressed, we pause the game
    				if( game.paused == false && this.ChoseDif != false ){
    					game.paused = true;
    					PVZM.pause();
    					this.PState = game.add.text(212, 190, "PAUSED", { fontSize: "80px", fill: "#324300"});
    					this.Pmess = game.add.text(239, 270, "Click anywhere in the game to unpause.", { fontSize: "15px", fill: "#fff"});
    				}
    			});

    			//************* INFO BUTTON *************\\
    			this.InfodimBack = this.add.sprite( 26, 23, 'InfoDim');

          if (!game.device.desktop && pltfrmCheck == false){ this.pltfrm(); } //go fullscreen and add buttons on mobile devices
          else{
            this.INFObut = this.add.sprite( 331.5, 422.5, 'pvzbutton');
      			info_label = game.add.text( 357, 425, 'OK', { fontSize: '23px', fill: '#ffffff' });
            info_label.inputEnabled = true;
      			info_label.events.onInputUp.add(function () {
      				this.OK = true;
      			});
          }

    			//Click Listener
    			game.input.onDown.add(unpause, self);

    			function unpause(event){
    				// Only act if paused
    				if ( this.InfodimBack != null ){
    					this.InfodimBack.destroy();
    				}
    				if(game.paused){
    					this.PState.destroy();
    					this.Pmess.destroy();
    					// Unpause the game
    					game.paused = false;
    					PVZM.resume();
    				}
          };
        },

    		pltfrm: function() {
          //this.INFObut = this.add.sprite( 331.5, 422.5, 'pvzbutton');
          info_label = game.add.text( 100, 425, 'SORRY, THIS GAME IS ONLY AVAILABLE ON PC.', { fontSize: '23px', fill: '#ff0000' });
    			pltfrmCheck = true;
    			//game.scale.startFullScreen(true);
    		},

    		updateCounter: function () {
    			if (scount == "GO!" && gametimeS == "-"){ 	// START GAME & TIME!
    				scount= "";
    				PVZM.play('', 0, 1, true);
    				this.input.disabled = false;
    				//this.move(Phaser.RIGHT);
            if(ToggleZombies){
      				this.moveZ(Phaser.LEFT, this.z1);
      				this.moveZ(Phaser.RIGHT, this.z2);
      				this.moveZ(Phaser.LEFT, this.z3);
      				this.moveZ(Phaser.RIGHT, this.z4);
      				if( DifContinue >=2){
      					this.moveZ(Phaser.LEFT, this.z5);
      					this.moveZ(Phaser.RIGHT, this.z6);
      				}
            }
    				gametimeM = 0;
    				gametimeS = 0;
    			}
    			else if(gametimeS == 59 ){					// TIME: COUNTING MINUTES
    				gametimeM++;
    				gametimeS = 0;
    				if( gametimeM == 1 ){
    					Wave.play();
    					this.THEtext.visible = true;
    					this.ZOMBIEStext.visible = true;
    					this.AREtext.visible = true;
    					this.HUNGRYtext.visible = true;

              if(ToggleZombies){
      					this.z1.speed = this.FullZombieSpeed;
      					this.z2.speed = this.FullZombieSpeed;
      					this.z3.speed = this.FullZombieSpeed;
      					this.z4.speed = this.FullZombieSpeed;
      					if( DifContinue >=2){
      						this.z5.speed = this.FullZombieSpeed;
      						this.z6.speed = this.FullZombieSpeed;
      					}
              }
    				}
    			}
    			else if (gametimeS != "-"){					// TIME: COUNTING SECONDS
    				gametimeS++;
    			}
    			else if (tcount == 1){ 						// STARTING COUNT-DOWN "GO"
    				scount= "GO!";
    				BEEP.play();
    			}
    			else if ( DifContinue != null ){										// STARTING COUNT-DOWN
    				tcount--;
    				if (tcount < 5) {
    					scount = "  " + tcount;
    					BEEP.play();
    					if ( (ChoseDif == false) && (placedPlayer==0)){
    						this.cDifText2.visible = false;
    						this.cDifText.visible = false;

    						DifBut1.visible = false;
                DifText1.visible = false;

                DifBut2.visible = false;
                DifText2.visible = false;

                DifBut3.visible = false;
                DifText3.visible = false;

    						this.pacman.visible = false;
    						this.input.disabled = true;

    						//-----------------PACMAN-----------------\\
    						//  Position Pacman at grid location 14x17 (the +8 accounts for his anchor)
    						this.pacman = this.add.sprite((16 * 16) + 8, (15 * 16) + 8, 'pacman', 0);
    						this.pacman.anchor.set(0.5);

    						this.physics.arcade.enable(this.pacman);
    						this.pacman.body.setSize(16, 16, 0, 0);

    						//  MUNCH ANIMATIONS
    						this.pacman.animations.add('munchRL', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], 40, true);
    						this.pacman.animations.add('munchUP', [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 40, true);
    						this.pacman.animations.add('munchDOWN', [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 40, true);

    						this.pacman.play('munchRL');
    						this.move(Phaser.NONE);
                placedPlayer=1;
    					}
    				}
    			}
    			if(Rtile>0){								// SUPERSPEED COUNT-DOWN
    				Rtile--;
    			}
    			else if(Rtile==0){							// VANISH SUPERSPEED
    				Rtile="";
    				this.superspeed.callAll('kill');
    			}
    			if(SpeedCD>0){								// COLLECTED SUPERSPEED DURATION COUNT-DOWN
    				SpeedCD--;
    			}
    			else if(SpeedCD == 0){						// COLLECTED SUPERSPEED DURATION OVER
    				SpeedCD=null;
    				this.speed=150;

    				this.KILLtext.visible = false;
    				this.THEMtext.visible = false;
    				this.ALLtext.visible = false;
    			}

          if(ToggleZombies){
      			if( DifContinue == 1 && ChoseDif == false ){
      				this.RegZombieSpeed = 70;
      				this.FullZombieSpeed = 100;

      				this.z1.speed = this.RegZombieSpeed;
      				this.z2.speed = this.RegZombieSpeed;
      				this.z3.speed = this.RegZombieSpeed;
      				this.z4.speed = this.RegZombieSpeed;

      				ChoseDif = true;
      			}
      			else if( DifContinue >= 2 && ChoseDif == false ){
      				//------------------ZOMBIE 5------------------\\
      				//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
      				this.z5 = this.add.sprite((16 * 16) + 8, (4 * 16) + 8, 'zombie', 0);
      				this.z5.anchor.set(0.5);
      				this.z5.speed = this.RegZombieSpeed;

      				this.physics.arcade.enable(this.z5);
      				this.z5.body.setSize(16, 16, 0, 0);

      				this.z5.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      				this.z5.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      				this.z5.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      				this.z5.play('walkRL');
      				this.Zcurrent = Phaser.RIGHT;

      				//------------------ZOMBIE 6------------------\\
      				//  Position Zombie at grid location 14x17 (the +8 accounts for his anchor)
      				this.z6 = this.add.sprite((39 * 16) + 8, (26 * 16) + 8, 'zombie', 0);
      				this.z6.anchor.set(0.5);
      				this.z6.speed = this.RegZombieSpeed;

      				this.physics.arcade.enable(this.z6);
      				this.z6.body.setSize(16, 16, 0, 0);

      				this.z6.animations.add('walkRL', [0, 1, 2, 3, 4], 40, true);
      				this.z6.animations.add('walkUP', [5, 6, 7, 8, 9], 40, true);
      				this.z6.animations.add('walkDOWN', [10, 11, 12, 13, 14], 40, true);

      				this.z6.play('walkRL');
      				this.Zcurrent = Phaser.RIGHT;
      				this.input.disabled = true;

      				if( DifContinue == 3 ){
      					this.RegZombieSpeed = 150;
      					this.FullZombieSpeed = 200;

      					this.z1.speed = this.RegZombieSpeed;
      					this.z2.speed = this.RegZombieSpeed;
      					this.z3.speed = this.RegZombieSpeed;
      					this.z4.speed = this.RegZombieSpeed;
      					this.z5.speed = this.RegZombieSpeed;
      					this.z6.speed = this.RegZombieSpeed;
      				}
      				ChoseDif = true;
            }
    			}
    		},

    		render: function () {
    			//game.debug.text('Time until event: ' + timer.duration.toFixed(0), 32, 30);
    			//game.debug.text('Tcount: ' + tcount, 32, 50);
    			//game.debug.text('Scount: ' + scount, 32, 70);
    			//game.debug.text('Zdir: ' + this.Zdir, 32, 50);
    			//game.debug.text('Zranddir: ' + this.Zranddir, 32, 70);
    			//game.debug.text('Zcurrent: ' + this.Zcurrent, 32, 90);
    			//game.debug.text('Gametime: ' + gametimeS + "''", 32, 90);
    			//game.debug.text('Get SuperSpeed! ' + Rtile, 32, 110);
    			//game.debug.text(OK, 32, 110);
    			//game.debug.text(this.InfodimBack, 32, 70);
    		},

        checkKeys: function () {

          if ((this.cursors.left.isDown && this.current !== Phaser.LEFT) && hitme == 1){
            this.checkDirection(Phaser.LEFT);
    				hitme=0;
    				setTimeout(function(){
    					hitme=1;
    				}, 50);
          }
          else if ((this.cursors.right.isDown && this.current !== Phaser.RIGHT) && hitme == 1){
            this.checkDirection(Phaser.RIGHT);
    				hitme=0;
    				setTimeout(function(){
    					hitme=1;
    				}, 50);
          }
          else if ((this.cursors.up.isDown && this.current !== Phaser.UP) && hitme == 1){
            this.checkDirection(Phaser.UP);
    				hitme=0;
    				setTimeout(function(){
    					hitme=1;
    				}, 50);
          }
          else if ((this.cursors.down.isDown && this.current !== Phaser.DOWN) && hitme == 1) {
            this.checkDirection(Phaser.DOWN);
            hitme=0;
            setTimeout(function(){
            	hitme=1;
    				}, 50);
          }
          else{
            //  This forces them to hold the key down to turn the corner
            this.turning = Phaser.NONE;
          }

        },

        checkDirection: function (turnTo) {

          if (this.turning === turnTo || this.directions[turnTo] === null || this.directions[turnTo].index !== 1 && this.directions[turnTo].index !== 82 && this.directions[turnTo].index !==83 && this.directions[turnTo].index !==84 && this.directions[turnTo].index !==85){
            //  Invalid direction if they're already set to turn that way
            //  Or there is no tile there, or the tile isn't index 1 (a floor tile)
            return;
          }
          //  Check if they want to turn around and can
          if (this.current === this.opposites[turnTo]){
            this.move(turnTo);
          }
          else{
              this.turning = turnTo;

              this.turnPoint.x = (this.marker.x * this.gridsize) + (this.gridsize / 2);
              this.turnPoint.y = (this.marker.y * this.gridsize) + (this.gridsize / 2);
          }

        },

        turn: function () {

          var cx = Math.floor(this.pacman.x);
          var cy = Math.floor(this.pacman.y);

          //  This needs a threshold, because at high speeds you can't turn because the coordinates skip past
          if (!this.math.fuzzyEqual(cx, this.turnPoint.x, this.threshold) || !this.math.fuzzyEqual(cy, this.turnPoint.y, this.threshold)){
            return false;
          }

          //  Grid align before turning
          this.pacman.x = this.turnPoint.x;
          this.pacman.y = this.turnPoint.y;

  			  if ( this.pacman.body != null ){
    				this.pacman.body.reset(this.turnPoint.x, this.turnPoint.y);

    				this.move(this.turning);

    				this.turning = Phaser.NONE;
  			   }

          return true;
        },

        move: function (direction) {

          var speed = this.speed;

          if (direction === Phaser.LEFT || direction === Phaser.UP)
          {
              speed = -speed;
          }

          if (direction === Phaser.LEFT || direction === Phaser.RIGHT)
          {
              this.pacman.body.velocity.x = speed;
          }
          else
          {
              this.pacman.body.velocity.y = speed;
          }

          //  Reset the scale and angle (Pacman is facing to the right in the sprite sheet)
          this.pacman.scale.x = 1;
          this.pacman.angle = 0;

          if (direction === Phaser.LEFT){
            this.pacman.play('munchRL');
            this.pacman.scale.x = -1;
          }
          else if (direction === Phaser.RIGHT){
            this.pacman.play('munchRL');
          }
          else if (direction === Phaser.UP){
            //this.pacman.angle = 270;
            this.pacman.play('munchUP');
          }
          else if (direction === Phaser.DOWN){
            //this.pacman.angle = 90;
            this.pacman.play('munchDOWN');
          }

            this.current = direction;
        },

    		checkZKeys: function (z) {
    			if( this.Zcurrent == Phaser.NONE ) {
    				this.Zcurrent = Phaser.RIGHT;
    			}
    			if( this.Zcurrent == Phaser.RIGHT || this.Zcurrent == Phaser.LEFT ){
    				this.Zranddir = game.rnd.integerInRange(1, 2);
    				if ( this.Zranddir == 1) { this.Zdir = Phaser.UP }
    				else if ( this.Zranddir == 2) { this.Zdir = Phaser.DOWN }
    				this.moveZ(this.Zdir, z);
    			}
    			else if( this.Zcurrent == Phaser.UP || this.Zcurrent == Phaser.DOWN ){
    				this.Zranddir = game.rnd.integerInRange(1, 4);
    				if ( this.Zranddir == 1) { this.Zdir = Phaser.LEFT }
    				else if ( this.Zranddir == 4) { this.Zdir = Phaser.RIGHT }
    				this.moveZ(this.Zdir, z);
    			}
    			if( this.Zdir == Phaser.NONE ){
    				this.Zdir = Phaser.RIGHT;
    				this.moveZ(this.Zdir, z);
    			}
        },

        checkZDirection: function (turnTo) {

          if (this.Zturning === turnTo || this.directions[turnTo] === null || this.directions[turnTo].index !== 1){
            //  Invalid direction if they're already set to turn that way
            //  Or there is no tile there, or the tile isn't index 1 (a floor tile)
            return;
          }

          //  Check if they want to turn around and can
          if (this.Zcurrent === this.opposites[turnTo]){
            this.moveZ(turnTo);
          }
          else{
            this.Zturning = turnTo;

            this.turnPoint.x = (this.marker.x * this.gridsize) + (this.gridsize / 2);
            this.turnPoint.y = (this.marker.y * this.gridsize) + (this.gridsize / 2);
          }

        },

        turnZ: function (z) {

          var cx = Math.floor(z.x);
          var cy = Math.floor(z.y);

          //  This needs a threshold, because at high speeds you can't turn because the coordinates skip past
          if (!this.math.fuzzyEqual(cx, this.turnPoint.x, this.threshold) || !this.math.fuzzyEqual(cy, this.turnPoint.y, this.threshold)){
            return false;
          }

          //  Grid align before Zturning
          z.x = this.turnPoint.x;
          z.y = this.turnPoint.y;

    			if( z.body != null ){
    				z.body.reset(this.turnPoint.x, this.turnPoint.y);

    				this.moveZ(this.Zturning, z);

    				this.Zturning = Phaser.NONE;
    			}

          return true;
        },

        moveZ: function (direction, z) {

          var Zspeed = z.speed;

          if (direction === Phaser.LEFT || direction === Phaser.UP){
            Zspeed = -Zspeed;
          }
          if (direction === Phaser.LEFT || direction === Phaser.RIGHT){
            z.body.velocity.x = Zspeed;
          }
          else{
            z.body.velocity.y = Zspeed;
          }

          //  Reset the scale and angle (Pacman is facing to the right in the sprite sheet)
          z.scale.x = 1;
          z.angle = 0;

          if (direction === Phaser.LEFT)
          {
  		      z.play('walkRL');
            z.scale.x = -1;
          }
  			  else if (direction === Phaser.RIGHT){
  				  z.play('walkRL');
          }
          else if (direction === Phaser.UP){
            //this.z1.angle = 270;
  				  z.play('walkUP');
          }
          else if (direction === Phaser.DOWN){
            //this.z1.angle = 90;
  				  z.play('walkRL');
          }

          this.Zcurrent = direction;
  			  if( this.Zcurrent == Phaser.NONE ) {
  				  this.Zcurrent = Phaser.RIGHT;
  			  }

        },

    		killPacman: function(z) {						//++++++++++++++++++++ KILL OR BE KILLED ON COLLISION WITH ZOMBIE ++++++++++++++++++++\\
    			if( SpeedCD != null ){
    				z.destroy();
    			}
    			else{
    				this.lives--;
    				this.pacman.destroy();
    				this.pacman = this.add.sprite((16 * 16) + 8, (15 * 16) + 8, 'pacman', 0);
    				this.pacman.animations.add('munchRL', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], 40, true);
    				this.pacman.animations.add('munchUP', [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 40, true);
    				this.pacman.animations.add('munchDOWN', [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 40, true);
    				this.pacman.anchor.set(0.5);
    				this.physics.arcade.enable(this.pacman);
    				this.pacman.body.setSize(16, 16, 0, 0);
    				this.pacman.play('munchRL');
    				this.move(Phaser.NONE);
    				if( this.lives == 0 ){
    					this.pacman.dead = true;
    					this.GameOver = game.add.text(140, 190, "GAME OVER", { fontSize: "80px", fill: "#a00000"});
    					this.YourTime = game.add.text(250, 266, "Your time: " + gametimeM + "':" + gametimeS + "''", { fontSize: "30px", fill: "#fff"});

    					this.StartGameTime1.visible = false;
    					this.StartGameTime2.visible = false;
    					this.SpeedHurry1.visible = false;
    					this.SpeedHurry2.visible = false;
    					this.KILLtext.visible = false;
    					this.THEMtext.visible = false;
    					this.ALLtext.visible = false;
    					this.THEtext.visible = false;
    					this.ZOMBIEStext.visible = false;
    					this.AREtext.visible = false;
    					this.HUNGRYtext.visible = false;

    					Laugh.play();
    					this.pacman.destroy();
    					pause_label.destroy();
    					this.but.destroy();
    				}
    			}
    		},

    		TreeToChurch: function() {
    			justGotHere = 1;
    			this.pacman.destroy();
    			this.pacman = this.add.sprite((35 * 16) + 8, (17 * 16) + 8, 'pacman', 0);
    			this.pacman.animations.add('munchRL', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], 40, true);
    			this.pacman.animations.add('munchUP', [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 40, true);
    			this.pacman.animations.add('munchDOWN', [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 40, true);
    			this.pacman.anchor.set(0.5);
    			this.physics.arcade.enable(this.pacman);
    			this.pacman.body.setSize(16, 16, 0, 0);
    			this.pacman.play('munchDOWN');
    			this.move(Phaser.NONE);
          this.cursors.up.isDown = false;
          setTimeout(function(){
    				justGotHere = 0;
    			}, 100);
    		},

    		ChurchToTree: function() {
    			justGotHere = 1;
    			this.pacman.destroy();
    			this.pacman = this.add.sprite((11 * 16) + 8, (17 * 16) + 8, 'pacman', 0);
    			this.pacman.animations.add('munchRL', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], 40, true);
    			this.pacman.animations.add('munchUP', [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 40, true);
    			this.pacman.animations.add('munchDOWN', [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 40, true);
    			this.pacman.anchor.set(0.5);
    			this.physics.arcade.enable(this.pacman);
    			this.pacman.body.setSize(16, 16, 0, 0);
    			this.pacman.play('munchDOWN');
    			this.move(Phaser.NONE);
          this.cursors.up.isDown = false;
          setTimeout(function(){
            justGotHere = 0;
          }, 100);
    		},

        eatDrop: function (pacman, drop) {
    			this.score++;
          drop.kill();
    			if (this.score %5 === 0 ){
    				Eat20Drops.play();
    			}
    			if (this.score == 50 && this.lives<3) {
    				this.score=0;
    				this.lives++;
    			}

          if (this.drops.total === 0){
            if(ToggleZombies){
              this.z1.destroy();
      				this.z2.destroy();
      				this.z3.destroy();
      				this.z4.destroy();
      				if( DifContinue >=2){
      					this.z5.destroy();
      					this.z6.destroy();
      				}
            }

    				this.GameOver = game.add.text(190, 190, "YOU WIN!", { fontSize: "80px", fill: "#a00000"});
    				this.YourTime = game.add.text(250, 266, "Your time: " + gametimeM + "':" + gametimeS + "''", { fontSize: "30px", fill: "#fff"});

    				this.StartGameTime1.visible = false;
    				this.StartGameTime2.visible = false;
    				this.SpeedHurry1.visible = false;
    				this.SpeedHurry2.visible = false;
    				this.KILLtext.visible = false;
    				this.THEMtext.visible = false;
    				this.ALLtext.visible = false;
    				this.THEtext.visible = false;
    				this.ZOMBIEStext.visible = false;
    				this.AREtext.visible = false;
    				this.HUNGRYtext.visible = false;

    				this.pacman.dead = true;
    				EatALLDrops.play();
    				pause_label.destroy();
    				this.but.destroy();
            //this.drops.callAll('revive');
          }
        },

    		eatSun: function (pacman, sun) {
    			EatSun.play();
          sun.kill();
    			SunSerialKiller++;
    			if (SunSerialKiller==5){
    				this.superspeed.callAll('revive');
    				SunSerialKiller=0;
    				Rtile = game.rnd.integerInRange(3, 8);
    			}
    			if (this.score == 50 && this.lives<3) {
    				this.score=0;
    				this.lives++;
    			}
      		if (this.suns.total === 0){
          	this.suns.callAll('revive');
          }
        },

    		eatSuperspeed: function (pacman, superspeed) {

    			Rtile="";
    			this.superspeed.callAll('kill');
    			this.speed=200;
    			SpeedCD = 5;
    			PraouPraou.play();

    			this.KILLtext.visible = true;
    			this.THEMtext.visible = true;
    			this.ALLtext.visible = true;
    		},

      	update: function () {

    			if(this.pacman.dead==true){						///+++   GAME OVER
    				this.input.disabled = true;
    				this.speed=0;
    				timer.stop();
    				PVZM.stop('', 0, 1, true);
    				EatSun.stop();
    			}

    			this.layer1 = this.layer;

    			//########### SCREEN MESSAGES & INFO ###########\\
    			// Score
    			this.CurrentScore1.text = "Score: " + this.score;
    			this.CurrentScore2.text = "Score: " + this.score;

    			// Lives
    			this.CurrentLives1.text = "Lives: ";
    			this.CurrentLives2.text = "Lives: ";
    			if(this.lives==0){
    				this.life1.visible = false;
    				this.life2.visible = false;
    				this.life3.visible = false;
    			}
    			else if(this.lives==1){
    				this.life1.visible = true;
    				this.life2.visible = false;
    				this.life3.visible = false;
    			}
    			else if(this.lives==2){
    				this.life1.visible = true;
    				this.life2.visible = true;
    				this.life3.visible = false;
    			}
    			else if(this.lives==3){
    				this.life1.visible = true;
    				this.life2.visible = true;
    				this.life3.visible = true;
    			}

    			// SuperSpeed Count-Down
    			this.SpeedHurry1.text = Rtile;
    			this.SpeedHurry2.text = Rtile;

    			// Starting Count-Down and Time
    			this.StartCount.text = scount;
    			this.StartGameTime1.text = "Time: " + gametimeM + ":" + gametimeS + "''";
    			this.StartGameTime2.text = "Time: " + gametimeM + "':" + gametimeS + "''";

      		this.physics.arcade.collide(this.pacman, this.layer);
      		this.physics.arcade.overlap(this.pacman, this.drops, this.eatDrop, null, this);
    			this.physics.arcade.overlap(this.pacman, this.suns, this.eatSun, null, this);
    			this.physics.arcade.overlap(this.pacman, this.superspeed, this.eatSuperspeed, null, this);

          if(ToggleZombies){
      			//PACMAN-ZOMBIE 1 COLLISIONS
      			this.physics.arcade.collide(this.z1, this.layer2, this.checkZKeys, null, this);
      			this.physics.arcade.overlap(this.z1, this.pacman, this.killPacman, null, this);

      			//PACMAN-ZOMBIE 2 COLLISIONS
      			this.physics.arcade.collide(this.z2, this.layer2, this.checkZKeys, null, this);
      			this.physics.arcade.overlap(this.z2, this.pacman, this.killPacman, null, this);

      			//PACMAN-ZOMBIE 3 COLLISIONS
      			this.physics.arcade.collide(this.z3, this.layer2, this.checkZKeys, null, this);
      			this.physics.arcade.overlap(this.z3, this.pacman, this.killPacman, null, this);

      			//PACMAN-ZOMBIE 4 COLLISIONS
      			this.physics.arcade.collide(this.z4, this.layer2, this.checkZKeys, null, this);
      			this.physics.arcade.overlap(this.z4, this.pacman, this.killPacman, null, this);

      			if( DifContinue >= 2){
      				//PACMAN-ZOMBIE 5 COLLISIONS
      				this.physics.arcade.collide(this.z5, this.layer2, this.checkZKeys, null, this);
      				this.physics.arcade.overlap(this.z5, this.pacman, this.killPacman, null, this);

      				//PACMAN-ZOMBIE 6 COLLISIONS
      				this.physics.arcade.collide(this.z6, this.layer2, this.checkZKeys, null, this);
      				this.physics.arcade.overlap(this.z6, this.pacman, this.killPacman, null, this);
      			}
          }

    			//PACMAN-TELEPORT COLLISIONS
    			if (justGotHere == 0){
    				this.physics.arcade.overlap(this.pacman, this.teleport1, this.TreeToChurch, null, this);
    				this.physics.arcade.overlap(this.pacman, this.teleport2, this.TreeToChurch, null, this);
    				this.physics.arcade.overlap(this.pacman, this.teleport3, this.ChurchToTree, null, this);
    				this.physics.arcade.overlap(this.pacman, this.teleport4, this.ChurchToTree, null, this);
    			}

          this.marker.x = this.math.snapToFloor(Math.floor(this.pacman.x), this.gridsize) / this.gridsize;
          this.marker.y = this.math.snapToFloor(Math.floor(this.pacman.y), this.gridsize) / this.gridsize;

          //  Update our grid sensors
          this.directions[1] = this.map.getTileLeft(this.layer.index, this.marker.x, this.marker.y);
          this.directions[2] = this.map.getTileRight(this.layer.index, this.marker.x, this.marker.y);
          this.directions[3] = this.map.getTileAbove(this.layer.index, this.marker.x, this.marker.y);
          this.directions[4] = this.map.getTileBelow(this.layer.index, this.marker.x, this.marker.y);

          this.checkKeys();

          if (this.turning !== Phaser.NONE){
            this.turn();
          }

          if(ToggleZombies){
            this.turnZ(this.z1);
          }

    			if( OK == false && this.InfodimBack == null ){
    				this.InfodimBack.visible = true;
    			}
          else if( OK == true ){
    				this.InfodimBack.visible = false;
    				this.INFObut.destroy();
    				info_label.destroy();
    			}

        }

      };
      game.state.add('Game', Pacman, true);

    </script>
  </body>
</html>
